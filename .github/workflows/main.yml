name: Deploy Final (Live + Database MySQL + WA)

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy Live System
    runs-on: ubuntu-latest
    steps:
      # --- 1. AMBIL KODE TERBARU ---
      - name: ðŸšš Ambil Kode
        uses: actions/checkout@v4

      # --- 2. SETUP & BUILD FRONTEND ---
      - name: ðŸŸ¢ Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ”¨ Build Frontend
        run: |
          cd frontend
          # Bersihkan instalasi lama agar fresh
          rm -rf node_modules package-lock.json
          
          # Install dependencies
          npm install --legacy-peer-deps
          npm install ajv@8 --save-dev --legacy-peer-deps
          
          # Build menjadi folder 'frontend/build'
          CI=false npm run build

      # --- 3. SETUP DATABASE & ENV (VERSI MYSQL) ---
      - name: ðŸ“ Buat File Database (.env)
        run: |
          cd backend
          
          # 1. DATABASE MYSQL (PENTING!)
          # Format: mysql+pymysql://USER:PASSWORD@localhost/DB_NAME
          echo "DATABASE_URL=mysql+pymysql://prow9975_admin_db:jates1110@localhost/prow9975_jates9_db" > .env
          
          # 2. KEAMANAN LOGIN
          echo "JWT_SECRET_KEY=rahasia_jates_super_aman" >> .env
          
          # 3. WHATSAPP (Watzap.id)
          echo "WHATSAPP_API_KEY=HHHI0XGX5GAV9COH" >> .env
          echo "WHATSAPP_NUMBER_KEY=Hyw8OdnzTHwbi88t" >> .env
          echo "WHATSAPP_SERVICE_URL=https://api.watzap.id/v1/send_message" >> .env
          
          # Cek file (Log)
          cat .env

      # --- 4. UPLOAD FRONTEND KE ROOT (public_html) ---
      - name: ðŸ“‚ Upload Web Utama (Frontend)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ftp.proptuneproject.com
          username: bimsrama@jagatetapsehat.com
          password: kuyen001
          local-dir: ./frontend/build/
          server-dir: ./
          exclude: |
            **/.git*
            **/.git*/**

      # --- 5. UPLOAD BACKEND KE FOLDER /backend_api/ ---
      - name: ðŸ“‚ Upload Backend (API)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ftp.proptuneproject.com
          username: bimsrama@jagatetapsehat.com
          password: kuyen001
          local-dir: ./backend/
          server-dir: ./backend_api/
          # PENTING: .env akan ikut terupload
          exclude: |
            **/node_modules/**
            **/.git*
            **/__pycache__/**
            **/*.pyc
