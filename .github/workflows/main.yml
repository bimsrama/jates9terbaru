name: Deploy Final (Live + Database MySQL + WA)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: ðŸš€ Build & Upload
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --- 1. BUILD FRONTEND ---
      - name: ðŸ”¨ Build Frontend
        run: |
          if [ -d "frontend" ]; then cd frontend; fi
          # Hapus cache lama agar bersih
          rm -rf node_modules package-lock.json
          npm install --force
          npm install ajv-keywords --save-dev --force
          CI=false npm run build
          
          # [PENTING] Buat .htaccess untuk React (Supaya tidak 404 saat refresh)
          cd build
          echo "Options -MultiViews" > .htaccess
          echo "RewriteEngine On" >> .htaccess
          echo "RewriteCond %{REQUEST_FILENAME} !-f" >> .htaccess
          echo "RewriteRule ^ index.html [QSA,L]" >> .htaccess

      # --- 2. PERSIAPAN BACKEND & ENV ---
      - name: ðŸ“ Buat File Config Backend
        run: |
          cd backend
          
          # A. Buat file .env (Menggunakan kredensial MySQL PROD)
          # Perhatikan: Username DB disesuaikan dengan info sebelumnya (adminjates_db)
          echo "DATABASE_URL=mysql+pymysql://prow9975_adminjates_db:jates1110@localhost/prow9975_jates9_db" > .env
          echo "JWT_SECRET_KEY=rahasia_jates_super_aman" >> .env
          echo "WHATSAPP_NUMBER_KEY=Hyw8OdnzTHwbi88t" >> .env
          echo "WHATSAPP_SERVICE_URL=https://api.watzap.id/v1/send_message" >> .env
          
          # Masukkan API Key OpenAI Anda di sini (Ganti SK-.... dengan key asli jika belum ada di secrets)
          # Jika Anda simpan di GitHub Secrets, gunakan: echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "OPENAI_API_KEY=sk-..." >> .env

          # B. Buat .htaccess untuk Python (Agar cPanel mendeteksi aplikasi)
          echo "PassengerAppRoot %{DOCUMENT_ROOT}" > .htaccess
          echo "PassengerAppType application/json" >> .htaccess
          echo "PassengerStartupFile main.py" >> .htaccess
          
          # Cek file (untuk debug log)
          cat .env

      # --- 3. UPLOAD FRONTEND (ROOT) ---
      - name: ðŸ“‚ Upload Frontend (Public HTML)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ftp.proptuneproject.com
          username: bimsrama@jagatetapsehat.com
          password: kuyen001
          
          # Ambil hasil build frontend
          local-dir: ./frontend/build/
          # Taruh di root domain
          server-dir: ./
          
          # Tidak menggunakan clean-slate di root agar aman (tidak menghapus folder backend_api)
          exclude: |
            **/.git*
            **/.github*
            **/node_modules/**
            backend_api/**

      # --- 4. UPLOAD BACKEND (FOLDER API) ---
      - name: ðŸ“‚ Upload Backend (API Folder)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ftp.proptuneproject.com
          username: bimsrama@jagatetapsehat.com
          password: kuyen001
          
          # Ambil folder backend
          local-dir: ./backend/
          # Taruh di folder khusus
          server-dir: ./backend_api/
          
          # [FITUR CLEAN INSTALL] Menghapus isi folder backend_api sebelum upload baru
          dangerous-clean-slate: true
          
          # env & htaccess IKUT terupload
          exclude: |
            **/node_modules/**
            **/.git*
            **/__pycache__/**
            **/venv/**
