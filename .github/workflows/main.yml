name: Deploy Final (Live + Database MySQL + WA)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: ðŸš€ Build & Upload via SFTP (Port 22)
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --- 1. BUILD FRONTEND ---
      - name: ðŸ”¨ Build Frontend
        run: |
          if [ -d "frontend" ]; then cd frontend; fi
          rm -rf node_modules package-lock.json
          npm install --force
          npm install ajv-keywords --save-dev --force
          CI=false npm run build
          
          # Fix React Routing
          cd build
          echo "Options -MultiViews" > .htaccess
          echo "RewriteEngine On" >> .htaccess
          echo "RewriteCond %{REQUEST_FILENAME} !-f" >> .htaccess
          echo "RewriteRule ^ index.html [QSA,L]" >> .htaccess

      # --- 2. PERSIAPAN BACKEND ---
      - name: ðŸ“ Buat Config Backend
        run: |
          cd backend
          
          # DATABASE MYSQL (Sesuai kredensial Anda)
          echo "DATABASE_URL=mysql+pymysql://prow9975_adminjates_db:jates1110@localhost/prow9975_jates9_db" > .env
          echo "JWT_SECRET_KEY=rahasia_jates_super_aman" >> .env
          echo "WHATSAPP_NUMBER_KEY=Hyw8OdnzTHwbi88t" >> .env
          echo "WHATSAPP_SERVICE_URL=https://api.watzap.id/v1/send_message" >> .env
          
          # PENTING: Masukkan API Key OpenAI Anda di sini (Ganti sk-...)
          echo "OPENAI_API_KEY=sk-..." >> .env

          # SETUP PYTHON CPANEL
          echo "PassengerAppRoot %{DOCUMENT_ROOT}" > .htaccess
          echo "PassengerAppType application/json" >> .htaccess
          echo "PassengerStartupFile main.py" >> .htaccess

      # --- 3. UPLOAD VIA SFTP (PORT 22) ---
      - name: ðŸ“‚ Upload Frontend via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: proptuneproject.com
          # PENTING: Untuk SFTP, biasanya username adalah USERNAME UTAMA cPanel (bukan email)
          # Jika 'bimsrama@...' gagal, coba ganti jadi 'bimsrama' saja atau 'prow9975' (sesuai prefix DB)
          username: bimsrama
          password: kuyen001
          port: 22 
          
          local_path: './frontend/build/*'
          remote_path: '/public_html/'
          sftp_only: true
          
          delete_remote_files: true
          ignore_remote_files: |
            backend_api/
            .well-known/
            cgi-bin/
            .htaccess
            .ftpquota

      - name: ðŸ“‚ Upload Backend via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: proptuneproject.com
          username: bimsrama
          password: kuyen001
          port: 22
          
          local_path: './backend/*'
          remote_path: '/public_html/backend_api/'
          sftp_only: true
          
          delete_remote_files: true
          ignore_remote_files: |
            venv/
            __pycache__/
            .python_egg_cache/
